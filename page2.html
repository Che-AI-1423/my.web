<script>
const SUPABASE_URL = "https://brszmjgodlmhsqkbcvmd.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJyc3ptamdvZGxtaHNxa2Jjdm1kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMjQ5NDAsImV4cCI6MjA2OTkwMDk0MH0.aIU16WE7MZdbJtPOb5qbPpizaufXaOtTnjgxcTqE-ik";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// 表單送出 → 呼叫 Supabase RPC
document.getElementById("searchForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const msg = document.getElementById("msg");
  msg.textContent = "搜尋中...";

  const min_followers = Number(document.getElementById("minFollowers").value || 0);
  const max_followers = Number(document.getElementById("maxFollowers").value || 999999999);
  const min_emg_rate = Number(document.getElementById("minEr").value || 0) / 100; // %
  const gender = ""; // 目前不輸入性別

  // 1️⃣ 呼叫 RPC: refresh_kol_search_cache（預過濾名單）
  const { data: cacheData, error: cacheErr } = await supabase.rpc("refresh_kol_search_cache", {
    min_followers,
    max_followers,
    min_emg_rate,
    p_gender: gender,
  });

  if (cacheErr) {
    msg.textContent = "查詢失敗：" + cacheErr.message;
    return;
  }

  // 2️⃣ 查詢 kol_ig_db 名單 (取前10個範例)
  const { data, error } = await supabase
    .from("kol_ig_db")
    .select("ig_name, instagram, ig_followers")
    .limit(10)
    .order("ig_followers", { ascending: false });

  if (error) {
    msg.textContent = "查詢錯誤：" + error.message;
    return;
  }

  if (!data || data.length === 0) {
    msg.textContent = "查無符合條件的網紅。";
    document.getElementById("result").style.display = "none";
    return;
  }

  msg.textContent = "";
  const resultBox = document.getElementById("result");
  resultBox.style.display = "block";
  resultBox.innerHTML = data
    .map(
      (r, i) =>
        `<div style="margin-bottom:6px;">
          <strong>${i + 1}. ${r.ig_name}</strong> 
          <a href="${r.instagram}" target="_blank">Instagram</a><br>
          粉絲數：${r.ig_followers?.toLocaleString?.() ?? "未知"}
        </div>`
    )
    .join("");
});
</script>
